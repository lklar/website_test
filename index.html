<html>
<head>
<title></title>

<link rel='stylesheet' href='./css/tour.css'>
<script src='./scripts/tour.js'></script>
<!-- <script src="./scripts/anime.min.js"></script> -->
<style>
#svgText > text {
    font-family: "Papyrus", Helvetica, serif;
    font-size: 40;
    fill:white;
    opacity: 0;
}
</style>

</head>

<body>

<div class="container">
    <canvas id="myCanvas"></canvas>
    <!-- <div id="clickablesContainer"></div> -->

    <!-- <svg id="svgTest" viewBox="0 0 200 200">
        <ellipse class="test" cx="50" cy="50" rx="20" ry="20" style="fill:none;stroke:black;stroke-width:1" />
        <ellipse class="test" cx="50" cy="50" rx="15" ry="15" style="fill:none;stroke:black;stroke-width:1" />
    </svg> -->

    <svg preserveAspectRatio="none" id="mySVG" viewBox="0 0 100 100">
        <defs>
            <mask id="pathMask"></mask>
            <g id="textPaths"></g>
        </defs>
        <g id="paths"></g>
        <g id="clickableAreas"></g>
        <g id="svgText"></g>
    </svg>

    <div id="imgCanvases"></div>
    
    <div id="infoText"></div>

</div>





<script type="module">
    import anime from './scripts/anime.es.js';
    var canvas = document.getElementById("myCanvas");
    var clickables = document.getElementById("clickablesContainer"); 
    var ctx = canvas.getContext("2d");
    var r = document.querySelector(':root');
    
    let maskSpeed = 200;
    let pathSpeed = 4000;

    let areas = {
        dust: {
            name : "dust",
            text : "Dust",
            cx : 120,
            cy : 250,
            rx : 120,
            ry : 75,
            alphaStart : 210,
            direction : "anti-clockwise"
        },

        pebbles: {
            name : "pebbles",
            text : "Pebbles",
            cx : 673,
            cy : 636,
            rx : 120,
            ry : 75,
            alphaStart : 270,
            direction : "clockwise"
        },

        protoplanet: {
            name : "protoplanet",
            text : "Protoplanet",
            cx : 1613,
            cy : 716,
            rx : 120,
            ry : 75,
            alphaStart : 0,
            direction : "anti-clockwise"
        }
    }

    let connections = {
        dustPebbles : {
            name : "dustPebbles",
            text : "Dust to Pebbles",
            from : areas.dust,
            to   : areas.pebbles,
            alpha1 : 210,
            dx1 : -300,
            dy1 : 100,
            alpha2 : 270,
            dx2 : -500,
            dy2 : 50
        },

        pebblesProtoplanet : {
            name : "pebblesProtoplanet",
            text : "Pebbles to Protoplanet",
            from : areas.pebbles,
            to   : areas.protoplanet,
            alpha1 : 65,
            dx1 : -400,
            dy1 : 150,
            alpha2 : 0,
            dx2 : 0,
            dy2 : 400
        }
    }

    let animations = {
        a1 : {
            target : "dustMask",
            start : 0,
            end : 1,
            duration : maskSpeed,
            onCompletion : dustCompleteFunc
        },
        a2 : {
            target : "dustPebblesMask",
            start : 0,
            end : 1,
            duration : maskSpeed,
            onCompletion : pebblesCompleteFunc

        },
        a3 : {
            target : "pebblesMask",
            start : 0,
            end : 1,
            duration : maskSpeed,
            onCompletion : dustPebblesCompleteFunc
        },
        a4 : {
            target : "pebblesProtoplanetMask",
            start : 0,
            end : 1,
            duration : maskSpeed,
            onCompletion : pebblesProtoplanetCompleteFunc
        },
        a5 : {
            target : "protoplanetMask",
            start : 0,
            end : 1,
            duration : maskSpeed,
            onCompletion : protoplanetCompleteFunc
        }
    }

    function dustCompleteFunc(mainTimeline)
    {
        let tl = anime.timeline({
                easing: 'linear'
        });
        tl.add({
                targets : ['#dustCanvas', '#dustText'],
                opacity : [0, 1],
                duration : 2000,
                complete : function(anim){
                        mainTimeline.play();
                }
            });
    }

    function dustPebblesCompleteFunc(mainTimeline)
    {
        let i = 0;
        let video = document.createElement('video');
        video.style.width = "20vw";
        video.style.position = "absolute";
        video.style.left = "5%";
        video.style.top = "55%";
        video.style.opacity = "0";
        video.src = "./img/collision.mp4";
        document.getElementById("infoText").appendChild(video);
        document.getElementById("dustPebblesText").style["opacity"] = "1.0";
        let cText = document.getElementById("dustPebblesText").children[0];
        let finalText = cText.innerHTML;
        cText.innerHTML = "";
        let tl = anime.timeline({
            easing: 'linear'
            });
        tl.pause();
        let interval = setInterval(function(){
            cText.innerHTML += finalText[i];
            ++i;
            if(i >= finalText.length)
            {
                clearInterval(interval);
                tl.play();
            }
        }, 100);
        tl.add({
                targets : video,
                opacity : [0, 1],
                duration : 2000,
                complete : function(anim){
                    video.play();
                    tl.pause();
                }
            });
        video.onended = function(event) {
            tl.play();
        }
        tl.add({
            targets : video,
            opacity : [1, 0],
            duration : 1000,
            complete : function(anim){
                document.getElementById("infoText").removeChild(video);
                mainTimeline.play();
            }
        })
    }

    function pebblesCompleteFunc(mainTimeline)
    {
        let tl = anime.timeline({
                easing: 'linear'
        });
        tl.add({
                targets : ['#pebblesCanvas', '#pebblesText'],
                opacity : [0, 1],
                duration : 2000,
                complete : function(anim){
                    mainTimeline.play();
                }
            });
    }

    function pebblesProtoplanetCompleteFunc(mainTimeline)
    {
        let i = 0;
        let video = document.createElement('video');
        video.style.width = "20vw";
        video.style.position = "absolute";
        video.style.right = "30%";
        video.style.top = "55%";
        video.style.opacity = "0";
        video.src = "./img/sticking_19mms-1.mp4";
        document.getElementById("infoText").appendChild(video);
        document.getElementById("pebblesProtoplanetText").style["opacity"] = "1.0";
        let cText = document.getElementById("pebblesProtoplanetText").children[0];
        let finalText = cText.innerHTML;
        cText.innerHTML = "";
        let tl = anime.timeline({
            easing: 'linear'
            });
        tl.pause();
        let interval = setInterval(function(){
            cText.innerHTML += finalText[i];
            ++i;
            if(i >= finalText.length)
            {
                clearInterval(interval);
                tl.play();
            }
        }, 100);
        tl.add({
                targets : video,
                opacity : [0, 1],
                duration : 2000,
                complete : function(anim){
                    video.play();
                    tl.pause();
                }
            });
        video.onended = function(event) {
            tl.play();
        }
        tl.add({
            targets : video,
            opacity : [1, 0],
            duration : 1000,
            complete : function(anim){
                document.getElementById("infoText").removeChild(video);
                mainTimeline.play();
            }
        })
            
    }

    function protoplanetCompleteFunc(mainTimeline)
    {
        let tl = anime.timeline({
                easing: 'linear'
        });
        tl.add({
                targets : ['#protoplanetCanvas', '#protoplanetText'],
                opacity : [0, 1],
                duration : 2000
            });
    }

    var img=new Image();
    img.src="img/exoplanets-disks.jpg";
    img.onload=function(){
        canvas.width = this.width;
        canvas.height = this.height;
        setUpSVG(this.width, this.height);

        for(const key in connections)
        {
            {
                let newPath = connectionPath(connections[key]);
                addMask(newPath, `${connections[key].name}Mask`);
                addPath(newPath, `${connections[key].name}Path`);
                let newArea = addArea(newPath, `${connections[key].name}Area`);
                newArea.setAttribute("fill", "none");

            }

            if (connections[key].from.isDisplayed != true)
            {
                let newPath = enclosurePath(connections[key].from);
                addMask(newPath, `${connections[key].from.name}Mask`);
                addPath(newPath, `${connections[key].from.name}Path`);
                addArea(newPath, `${connections[key].from.name}Area`);
                connections[key].from.isDisplayed = true;
            }

            if (connections[key].to.isDisplayed != true)
            {
                let newPath = enclosurePath(connections[key].to);
                addMask(newPath, `${connections[key].to.name}Mask`);
                addPath(newPath, `${connections[key].to.name}Path`);
                addArea(newPath, `${connections[key].to.name}Area`);
                connections[key].to.isDisplayed = true;
            }
            
        }

        addCanvasForArea(areas.dust, "img/IDP.jpg", this.width, this.height);
        addCanvasForArea(areas.pebbles, "img/Pebble_Labor_2.jpg", this.width, this.height);
        addCanvasForArea(areas.protoplanet, "img/arrokoth.png", this.width, this.height);

        let dashLength = document.getElementById("dustPath").getTotalLength() / 32;
        document.getElementById("paths").setAttribute("stroke-dasharray", `${dashLength} ${dashLength}`);
        r.style.setProperty('--dashLength', `${2*dashLength}`)

        let maskTimeline = anime.timeline({
            easing: 'linear'
        });

        addAreaText(areas.dust, 25, 30);
        addAreaText(areas.pebbles, 25, 30);
        addAreaText(areas.protoplanet, 15, 30);
        addConnectionText(connections.dustPebbles, -30, 40, 40);
        addConnectionText(connections.pebblesProtoplanet, -10, 50, 30);

        for (const key in animations)
        {
            let ani = animations[key];
            let target = document.getElementById(ani.target);
            let targetLength = target.getTotalLength();
            maskTimeline.add({
                targets: target,
                strokeDashoffset: [(1-ani.start) * targetLength, (1-ani.end) * targetLength],
                duration: ani.duration,
                complete: function(anim){
                    maskTimeline.pause();
                    ani.onCompletion(maskTimeline);
             }
            }, ani.atTime);
        }

        //addToTimeline(maskTimeline, "dustMask", 0, 1, areas.dust.onCompletion, maskSpeed/5);
        //addToTimeline(maskTimeline, "dustPebblesMask", 0, 1, maskSpeed/5);
        // addToTimeline(maskTimeline, "pebblesMask", 0, 0.5, maskSpeed/10);
        // addToTimeline(maskTimeline, "pebblesMask", 0.5, 1, maskSpeed/10);
        // addToTimeline(maskTimeline, "pebblesProtoplanetMask", 0, 1, maskSpeed/5, `-=${maskSpeed / 10}`);
        // addToTimeline(maskTimeline, "protoplanetMask", 0, 1, maskSpeed/5);

        // document.getElementById('dustArea').addEventListener("click", function(){
        //     processDustClick();
        // });
        // document.getElementById('dustPebblesArea').addEventListener("click", function(){
        //     processDustPebblesClick();
        // });
        // document.getElementById('pebblesArea').addEventListener("click", function(){
        //     processPebblesClick();
        // });
        // document.getElementById('pebblesProtoplanetArea').addEventListener("click", function(){
        //     processPebblesProtoplanetClick();
        // });
        // document.getElementById('protoplanetArea').addEventListener("click", function(){
        //     processProtoplanetClick();
        // });

        // let newPathElement = document.createElementNS("http://www.w3.org/2000/svg","path");
        // let myPath = "";
        // {
        //     myPath += `M 530,330`;
        //     let startPoint = pointOnEllipse(530, 330, 100, 50, 90);
        //     let endPoint = pointOnEllipse(530, 330, 100, 50, 270);
        //     myPath += `M ${startPoint.x},${startPoint.y} A ${100} ${50} 0 1 1 ${endPoint.x} ${endPoint.y}`;
        //     startPoint = pointOnEllipse(530, 330, 100, 50, 270);
        //     endPoint = pointOnEllipse(530, 330, 100, 50, 90);
        //     myPath += `A ${100} ${50} 0 1 1 ${endPoint.x} ${endPoint.y}`;
        // }
        // newPathElement.setAttribute("d", myPath)
        // let pathLength = newPathElement.getTotalLength();
        // myPath += `c ${-100} ${0} -500 0 ${-50} ${350}`;
        // // {
        // //     let startPoint = pointOnEllipse(530, 330, 100, 50, 145);
        // //     let endPoint = pointOnEllipse(0, 0, 100, 50, 0);
        // //     myPath += `a ${100} ${50} 0 1 1 ${endPoint.x} ${endPoint.y}`
        // // }
        
        // newPathElement.setAttribute("id", `myPath`);
        // newPathElement.setAttribute("d", myPath);
        // newPathElement.setAttribute("stroke-linecap", "round");
        // //let pathLength = newPathElement.getTotalLength();
        // newPathElement.setAttribute("stroke-dasharray",`${pathLength / 8} ${pathLength / 8}`);
        // newPathElement.setAttribute("mask", "url(#theMask)");
        // //newPath.style.transformOrigin = `${100 * area.X / width}% ${100 * area.Y / height}%`;
        // document.getElementById("mySVG").appendChild(newPathElement);

        // {
        //     let newMaskElement = document.createElementNS("http://www.w3.org/2000/svg","path");
        //     newMaskElement.setAttribute("d", myPath);
        //     newMaskElement.setAttribute("id", "myMask");
        //     newMaskElement.setAttribute("fill", "none");
        //     newMaskElement.setAttribute("stroke", "#fff");
        //     newMaskElement.setAttribute("stroke-linecap", "round");
        //     //newMaskElement.setAttribute("stroke-miterlimit", "10");
        //     newMaskElement.setAttribute("stroke-width", "10");
        //     document.getElementById("theMask").appendChild(newMaskElement);
        //     let maskLength = newMaskElement.getTotalLength();
        //     // anime({
        //     //     targets: newMaskElement,
        //     //     strokeDashoffset: [0, maskLength],
        //     //     duration: 10000,
        //     //     easing: 'linear'
        //     // });
        // }

        // anime({
        //     targets: newPathElement,
        //     strokeDashoffset: [0, pathLength],
        //     loop: true,
        //     direction: 'reverse',
        //     duration: 5000,
        //     easing: 'linear'
        // });

        // anime({
        //     targets: "#myMask",
        //     strokeDashoffset: [1152, 0],
        //     //loop: true,
        //     //direction: 'reverse',
        //     duration: 5000,
        //     easing: 'linear'
        // });
        

        // for(const key in areas)
        // {
        //     //convertPixelToRelativeValues(areas[key], this.width, this.height);
        //     let newPath = addEnclosingPath(areas[key], this.width, this.height);
        //     anime({
        //         targets: newPath,
        //         //translateX: 250,
        //         //rotateZ: 360,
        //         strokeDashoffset: [offsetStart[key], offsetStart[key] + 200],
        //         loop: true,
        //         //backgroundColor: '#FFF',
        //         //direction: 'alternate',
        //         //delay : delays[key],
        //         duration: durations[key],
        //         easing: 'linear'
        //     });
        //     console.log(`${key} has duration of ${newPath.getTotalLength()}`);
        // }

        // for(const key in connections)
        // {
        //     let newPath = addPathForConnection(connections[key], key);
        //     anime({
        //         targets: newPath,
        //         //translateX: 250,
        //         //rotateZ: 360,
        //         strokeDashoffset: [offsetStart[key], offsetStart[key] + 200],
        //         loop: true,
        //         //backgroundColor: '#FFF',
        //         //direction: 'alternate',
        //         //delay : delays[key],
        //         duration: durations[key],
        //         easing: 'linear'
        //     });
        //     console.log(`${key} has length of ${newPath.getTotalLength()}`);
        // }

        //setUpSVG(this.width, this.height);

        // for(const area in areas)
        // {
        //     let newCanvas = addCanvasForArea(areas[area], this);
        //     newCanvas.addEventListener("mouseenter", function(){
        //         r.style.setProperty('--backgroundOpacity', '0.5');
        //         r.style.setProperty('--clickablesOpacity', '0');
        //         newCanvas.style.opacity = "1.0";
        //         //newCanvas.style.animation = "zoomIn 1s forwards";
        //     });
        //     newCanvas.addEventListener("mouseout", function(){
        //         r.style.setProperty('--backgroundOpacity', '1.0');
        //         r.style.setProperty('--clickablesOpacity', '1.0')
        //         newCanvas.style.opacity = "var(--clickablesOpacity)";
        //         //newCanvas.style.animation = "zoomNormal 1s forwards";
        //     });
        //     addEnclosingPath(areas[area], this.width, this.height);
        // }
        
        // for(const connection in connections)
        // {
        //     addPathForConnection(connections[connection], connection, this.width, this.height);
        // }
        ctx.drawImage(this,0,0);
        
    }
    
</script>

</body>
</html>